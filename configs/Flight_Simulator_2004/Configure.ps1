Write-Output "Configuring Flight Simulator 2004 for use with ControllerBuddy-Profiles...`n"

$fs9Dir = "$env:APPDATA\Microsoft\FS9"

if (-not (Test-Path $fs9Dir -PathType Container)) {
    Write-Output "Error: Flight Simulator 2004 config directory '$fs9Dir' does not exist"
    Exit 1
}

Import-Module -Name "$PSScriptRoot\..\.lib\DirectInput"

$vJoyDevice = Get-VJoyDevice

if ($null -eq $vJoyDevice) {
    Write-Output 'Error: Could not find vJoy device'
    Exit 1
}

$gamepadDevices = Get-GamepadDeviceList

if (-not (Test-Path -Path 'HKCU:\Software\Wine')) {
    while ($gamepadDevices.Count -lt 1) {
        Add-Type -AssemblyName PresentationCore, PresentationFramework

        if ([System.Windows.MessageBox]::Show("There is currently no controller connected.`nTo retry, please connect your controller now.`n`nRetry?", 'No controller connected', [System.Windows.MessageBoxButton]::YesNo, [System.Windows.MessageBoxImage]::Warning) -ne [System.Windows.MessageBoxResult]::Yes) {
            Write-Output 'Error: No controller connected'
            Exit 1
        }

        $gamepadDevices = Get-GamepadDeviceList
    }
}

function Get-DeviceGuid {
    param (
        [Parameter(Mandatory)]
        [object]$Device
    )

    $Device.InstanceGuid.ToString().ToUpper()
}

$fs9CfgFile = "$fs9Dir\fs9.CFG"
if (-not (Test-Path $fs9CfgFile -PathType Leaf)) {
    Write-Output "Error: Flight Simulator 2004 config file '$fs9CfgFile' does not exist"
    Exit 1
}

try {
    $fs9CfgContent = (Get-Content -Raw $fs9CfgFile) -replace '\[(JOYSTICK_(MAIN|SLEW) \{[a-fA-F0-9-]{36}\}|KEYBOARD_(MAIN|SLEW))\]\r\n[^\[]*'
    if ($fs9CfgContent -notmatch "`r?`n$") {
        $fs9CfgContent += "`r`n"
    }
    $vJoyDeviceGuid = Get-DeviceGuid $vJoyDevice
    $fs9CfgContent += @"
[JOYSTICK_MAIN {$vJoyDeviceGuid}]
AXIS_EVENT_00=AXIS_AILERONS_SET
AXIS_SCALE_00=127
AXIS_NULL_00=36
AXIS_EVENT_01=AXIS_ELEVATOR_SET
AXIS_SCALE_01=127
AXIS_NULL_01=36
AXIS_EVENT_02=AXIS_THROTTLE_SET
AXIS_SCALE_02=127
AXIS_NULL_02=0
AXIS_EVENT_03=AXIS_PAN_HEADING
AXIS_SCALE_03=127
AXIS_NULL_03=0
AXIS_EVENT_04=AXIS_PAN_PITCH
AXIS_SCALE_04=127
AXIS_NULL_04=0
AXIS_EVENT_05=AXIS_RUDDER_SET
AXIS_SCALE_05=127
AXIS_NULL_05=50
AXIS_EVENT_06=AXIS_PROPELLER_SET
AXIS_SCALE_06=127
AXIS_NULL_06=0
AXIS_EVENT_07=AXIS_MIXTURE_SET
AXIS_SCALE_07=127
AXIS_NULL_07=0
BUTTON_DOWN_EVENT_00=PAN_DOWN
BUTTON_UP_EVENT_00=PAN_RESET_COCKPIT
BUTTON_DOWN_EVENT_01=PAN_UP
BUTTON_UP_EVENT_01=PAN_RESET_COCKPIT
BUTTON_DOWN_EVENT_02=PAN_RIGHT
BUTTON_UP_EVENT_02=PAN_RESET_COCKPIT
BUTTON_DOWN_EVENT_03=PAN_LEFT
BUTTON_UP_EVENT_03=PAN_RESET_COCKPIT
BUTTON_DOWN_EVENT_04=BRAKES_LEFT
BUTTON_DOWN_REPEAT_04=1
BUTTON_DOWN_EVENT_05=BRAKES_RIGHT
BUTTON_DOWN_REPEAT_05=1
[JOYSTICK_SLEW {$vJoyDeviceGuid}]
AXIS_EVENT_00=AXIS_SLEW_SIDEWAYS_SET
AXIS_SCALE_00=127
AXIS_NULL_00=36
AXIS_EVENT_01=AXIS_SLEW_AHEAD_SET
AXIS_SCALE_01=127
AXIS_NULL_01=36
AXIS_EVENT_02=AXIS_SLEW_ALT_SET
AXIS_SCALE_02=-127
AXIS_NULL_02=36
AXIS_EVENT_03=AXIS_PAN_HEADING
AXIS_SCALE_03=127
AXIS_NULL_03=0
AXIS_EVENT_04=AXIS_PAN_PITCH
AXIS_SCALE_04=127
AXIS_NULL_04=0
AXIS_EVENT_05=AXIS_SLEW_HEADING_SET
AXIS_SCALE_05=127
AXIS_NULL_05=36

"@
    $gamepadDevices | ForEach-Object {
        $gamepadDeviceGuid = Get-DeviceGuid $_
        $fs9CfgContent += @"
[JOYSTICK_MAIN {$gamepadDeviceGuid}]
BUTTON_DOWN_REPEAT_00=1
[JOYSTICK_SLEW {$gamepadDeviceGuid}]
BUTTON_DOWN_REPEAT_00=1

"@
    }
    $fs9CfgContent += @"
[KEYBOARD_MAIN]
SELECT_1=49,8
SELECT_2=50,8
SELECT_3=51,8
SELECT_4=52,8
MINUS=189,8
PLUS=187,8
ZOOM_1X=8,8
SOUND_TOGGLE=81,8
ENGINE=69,8
SIM_RATE=82,8
XPNDR=84,8
SLEW_TOGGLE=89,8
EGT=85,8
SMOKE_TOGGLE=73,8
STROBES_TOGGLE=79,8
PAUSE_TOGGLE=80,8
PAUSE_TOGGLE#1=19,8
ATC=192,8
ATC#1=145,8
ADF=65,8
VIEW_MODE=83,8
HEADING_GYRO_SET=68,8
DME=70,8
GEAR_TOGGLE=71,8
ANTI_ICE_TOGGLE=72,8
JET_STARTER=74,8
JOYSTICK_CALIBRATE=75,10
ALL_LIGHTS_TOGGLE=76,8
SITUATION_SAVE=186,8
VIEW_WINDOW_TO_FRONT=222,8
AP_MASTER=90,8
FREQUENCY_SWAP=88,8
COM_RADIO=67,8
VOR_OBS=86,8
BAROMETRIC=66,8
NAV_RADIO=78,8
MAGNETO=77,8
BRAKES=190,8
SPOILERS_TOGGLE=191,8
SITUATION_RESET=186,10
FLAPS_UP=116,8
THROTTLE_FULL=115,8
THROTTLE_INCR_SMALL=114,8
THROTTLE_DECR=113,8
FLAPS_DOWN=119,8
THROTTLE_CUT=112,8
VIEW=111,8
ELEV_TRIM_DN=36,8
ELEV_DOWN=38,8
INCREASE_THROTTLE=33,8
AILERONS_LEFT=37,8
CENTER_AILER_RUDDER=12,8
AILERONS_RIGHT=39,8
ELEV_TRIM_UP=35,8
ELEV_UP=40,8
DECREASE_THROTTLE=34,8
VIEW_FORWARD=38,41
VIEW_FORWARD_RIGHT=33,41
VIEW_RIGHT=39,41
VIEW_REAR_RIGHT=34,41
VIEW_REAR=40,41
VIEW_REAR_LEFT=35,41
VIEW_LEFT=37,41
VIEW_FORWARD_LEFT=36,41
VIEW_DOWN=12,41
RUDDER_LEFT=45,8
RUDDER_RIGHT=135,8
BRAKES_LEFT=122,8
BRAKES_RIGHT=123,8
AP_ATT_HOLD=84,10
AP_LOC_HOLD=79,10
AP_APR_HOLD=65,10
AP_HDG_HOLD=72,10
AP_ALT_HOLD=90,10
AP_WING_LEVELER=86,10
AP_BC_HOLD=66,10
AP_NAV1_HOLD=78,10
EXIT=67,10
ABORT=3,10
READOUTS_FLIGHT=90,9
PANEL_TOGGLE=219,9
VIEW_MODE_REV=83,9
PANEL_LIGHTS_TOGGLE=76,9
LANDING_LIGHTS_TOGGLE=76,10
PARKING_BRAKES=190,10
MINUS_SHIFT=189,9
PLUS_SHIFT=187,9
FLAPS_INCR=118,8
FLAPS_DECR=117,8
PROP_PITCH_LO=115,10
PROP_PITCH_INCR_SMALL=114,10
PROP_PITCH_DECR=113,10
PROP_PITCH_HI=112,10
MIXTURE_RICH=115,11
MIXTURE_INCR_SMALL=114,11
MIXTURE_DECR=113,11
MIXTURE_LEAN=112,11
SCRIPT_EVENT_1=219,10
SCRIPT_EVENT_2=221,10
YAW_DAMPER_TOGGLE=68,10
CENTER_NT361_CHECK=57,11
CLOSE_VIEW=221,8
NEW_VIEW=219,8
NEW_MAP=221,9
NEXT_VIEW=9,10
PREV_VIEW=9,11
VIEW_TYPE=83,10
VIEW_TYPE_REV=83,11
RADIO_VOR1_IDENT_TOGGLE=49,10
RADIO_VOR2_IDENT_TOGGLE=50,10
RADIO_DME1_IDENT_TOGGLE=52,10
RADIO_ADF_IDENT_TOGGLE=53,10
GEAR_PUMP=71,10
SPOILERS_ARM_TOGGLE=191,9
PITOT_HEAT_TOGGLE=72,9
AP_AIRSPEED_HOLD=82,10
AUTO_THROTTLE_ARM=82,9
AUTO_THROTTLE_TO_GA=71,11
LANDING_LIGHT_UP=38,11
LANDING_LIGHT_DOWN=40,11
LANDING_LIGHT_LEFT=37,11
LANDING_LIGHT_RIGHT=39,11
LANDING_LIGHT_HOME=12,11
PAN_RESET=46,9
KNEEBOARD_VIEW=121,8
MP_PLAYER_CYCLE=84,11
MP_PLAYER_SNAP=70,11
MP_GO_OBSERVER=79,11
MP_CHAT=221,11
MP_ACTIVATE_CHAT=13,8
PANEL_1=49,9
PANEL_2=50,9
PANEL_3=51,9
PANEL_4=52,9
PANEL_5=53,9
PANEL_6=54,9
PANEL_7=55,9
PANEL_8=56,9
PANEL_9=57,9
AP_MACH_HOLD=77,10
VIEW_FORWARD_UP=38,42
VIEW_FORWARD_RIGHT_UP=33,42
VIEW_REAR_RIGHT_UP=34,42
VIEW_REAR_UP=40,42
VIEW_REAR_LEFT_UP=35,42
VIEW_FORWARD_LEFT_UP=36,42
VIEW_UP=12,42
INVOKE_HELP=191,10
INVOKE_HELP#1=191,11
TOGGLE_AIRCRAFT_LABELS=76,11
ENGINE_AUTO_START=69,10
INC_COWL_FLAPS=86,11
DEC_COWL_FLAPS=67,11
USER_INTERRUPT=27,8
AILERON_TRIM_LEFT=37,10
AILERON_TRIM_RIGHT=39,10
RUDDER_TRIM_LEFT=45,10
RUDDER_TRIM_RIGHT=135,10
TOGGLE_FLIGHT_DIRECTOR=70,10
TOGGLE_AFTERBURNER=115,9
TOGGLE_MASTER_BATTERY_ALTERNATOR=77,9
TOGGLE_AIRCRAFT_EXIT=69,9
PANEL_HUD_TOGGLE=87,8
SNAP_TO_PANEL=45,41
MARKER_SOUND_TOGGLE=51,10
TOGGLE_WATER_RUDDER=87,9
TOGGLE_PUSHBACK=80,9
KEY_CHASE_VIEW_NEXT=87,10
KEY_CHASE_VIEW_PREV=87,11
HEADING_BUG_SELECT=72,11
ALTITUDE_BUG_SELECT=90,11
CHASE_VIEW_TOGGLE=81,10
EYEPOINT_UP=13,9
EYEPOINT_DOWN=8,9
EYEPOINT_RIGHT=13,11
EYEPOINT_LEFT=8,11
EYEPOINT_FORWARD=8,10
EYEPOINT_BACK=13,10
EYEPOINT_RESET=32,8
AIRSPEED_BUG_SELECT=82,11
TOGGLE_TAILWHEEL_LOCK=71,9
ROTOR_BRAKE=66,9
ROTOR_CLUTCH_SWITCH_TOGGLE=190,9
ROTOR_GOV_SWITCH_TOGGLE=188,9
VIRTUAL_COPILOT_TOGGLE=88,11
VIRTUAL_COPILOT_ACTION=88,10
[KEYBOARD_SLEW]
SLEW_TOGGLE=89,8
SLEW_ALTIT_UP_FAST=115,8
SLEW_ALTIT_UP_SLOW=114,8
SLEW_ALTIT_FREEZE=113,8
SLEW_ALTIT_DN_FAST=112,8
SLEW_ALTIT_PLUS=81,8
SLEW_ALTIT_MINUS=65,8
SLEW_PITCH_DN_FAST=119,8
SLEW_PITCH_DN_SLOW=118,8
SLEW_PITCH_FREEZE=117,8
SLEW_PITCH_UP_FAST=116,8
SLEW_PITCH_PLUS=57,8
SLEW_PITCH_MINUS=48,8
READOUTS_SLEW=90,9
SLEW_BANK_MINUS=36,8
SLEW_AHEAD_PLUS=38,8
SLEW_BANK_PLUS=33,8
SLEW_LEFT=37,8
SLEW_FREEZE=12,8
SLEW_RIGHT=39,8
SLEW_HEADING_MINUS=35,8
SLEW_AHEAD_MINUS=40,8
SLEW_HEADING_PLUS=34,8
SLEW_RESET=32,8
TOGGLE_AIRCRAFT_LABELS=76,11
EYEPOINT_UP=13,9
EYEPOINT_DOWN=8,9
EYEPOINT_RIGHT=13,11
EYEPOINT_LEFT=8,11
EYEPOINT_FORWARD=8,10
EYEPOINT_BACK=13,10
"@

    Set-Content -Path $fs9CfgFile -Value $fs9CfgContent
    Write-Output "Updated file: $fs9CfgFile"
} catch {
    Write-Output "Error: Could not update file: $fs9CfgFile"
    Exit 1
}

Write-Output "`nFlight Simulator 2004 is now fully configured!"
Exit 0